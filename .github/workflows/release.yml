
name: Release
on:
  push:
    branches: 
      - master

jobs:

  release:
    runs-on: ubuntu-20.04
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0 # Needed for git-based changelog.
      - uses: actions/setup-java@v3
        with:
          distribution: 'adopt'
          java-version: 17
          cache: 'sbt'
      - uses: actions/setup-python@v2
        with:
          python-version: '3.7.5'
          cache: 'pip'
      - uses: actions/cache@v3
        with:
          key: ci-${{ github.job }}-${{ github.ref_name }}
          restore-keys: |
            ci-${{ github.job }}-master
          path: |
            **/target/**/*
      - name: Setup Release Credentials
        env:
          PYPIRC_B64: ${{ secrets.PYPIRC_B64 }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SSH_CONFIG_B64: ${{ secrets.SSH_CONFIG_B64 }}
          SSH_IDRSA_B64: ${{ secrets.SSH_IDRSA_B64 }}
        run: ./.github/scripts/setup-env.sh
      - run: |
          sudo snap install task --classic
          sudo snap install hub --classic
          python3 -m pip install setuptools
      - name: Publish Python Docs
        run: task py:publish-docs
      - name: Publish Site
        run: |
          mkdir -p docs/_site
          chmod -R 777 docs
          task docs:publish
      - name: Publish to PyPi
        run: task py:publish-release
      - name: Publish to Github
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: task jvm:plugin:publish:release
