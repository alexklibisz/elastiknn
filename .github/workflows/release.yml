name: Release
on:
  push:
    branches: 
      - master

jobs:

  check:
    runs-on: ubuntu-20.04
    steps:
    - name: Check if release exists for this version.
      run: |
        curl -s -o /dev/null -w "%{http_code}" https://github.com/alexklibisz/elastiknn/releases/tag/$(cat version) > status
        echo "RELEASE_STATUS=$(cat status)" >> $GITHUB_ENV
        printenv | grep RELEASE_STATUS

  release:
    runs-on: ubuntu-20.04
    if: env.RELEASE_STATUS == '404'
    steps:
    - uses: actions/checkout@v2
    - name: Setup Python
      run: |
        python3 --version
        sudo apt-get install -y python3-setuptools
    - name: Setup Java
      uses: actions/setup-java@v1
      with:
        java-version: 14
    - name: Setup Ruby
      uses: actions/setup-ruby@v1
      with:
        ruby-version: '2.6'
      run: gem install bundler

    # Has to run after installing languages.
    - name: Setup Environment
      env:
        GPG_SECRET_B64: ${{ secrets.GPG_SECRET_B64 }}
        GRADLE_PROPERTIES_B64: ${{ secrets.GRADLE_PROPERTIES_B64 }}
        PYPIRC_B64: ${{ secrets.PYPIRC_B64 }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SSH_CONFIG_B64: ${{ secrets.SSH_CONFIG_B64 }}
        SSH_IDRSA_B64: ${{ secrets.SSH_IDRSA_B64 }}
      run: ./.github/scripts/setup-env.sh

    - name: Publish Site
      run: make publish/site

    - name: Publish Docs
      run: make publish/docs

    - name: Release Python
      run: make publish/release/python

    - name: Release Scala
      run: make publish/release/sonatype

    - name: Release Plugin
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: make publish/release/plugin