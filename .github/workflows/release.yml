# Placeholder for running a release when a PR is merged and the version file has changed.
name: Release
on:
  push:
    branches: 
      - master
  pull_request:
    branches:
      - master
jobs:
  release:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: Check if release exists for this version
      run: |
        curl -s -o /dev/null -w "%{http_code}" https://github.com/alexklibisz/elastiknn/releases/tag/$(cat version) > status
        echo "::set-env name=GET_RELEASE::$(cat status)"
        rm status
    - name: Will release run?
      if: env.GET_RELEASE == '404'
      run: echo Yes

    # Language Setup
    - name: Setup Python
      if: github.event_name == 'push' && env.GET_RELEASE == '404'
      run: |
        python3 --version
        sudo apt-get install -y python3-setuptools

    - name: Setup Java
      uses: actions/setup-java@v1
      if: github.event_name == 'push' && env.GET_RELEASE == '404'
      with:
        java-version: 12.0.2

    # Release docs
    - name: Setup Docs
      if: github.event_name == 'push' && env.GET_RELEASE == '404'
      run: |
        cp docs/Gemfile .

    # Specify the Jekyll source location as a parameter
    - uses: helaili/jekyll-action@2.0.0
      if: github.event_name == 'push' && env.GET_RELEASE == '404'
      env:
        JEKYLL_PAT: ${{ secrets.JEKYLL_PAT }}
      with:
        jekyll_src: 'docs'

    # Release software
    - name: Release software artifacts
      env:
        GPG_SECRET_B64: ${{ secrets.GPG_SECRET_B64 }}
        GRADLE_PROPERTIES_B64: ${{ secrets.GRADLE_PROPERTIES_B64 }}
        PYPIRC_B64: ${{ secrets.PYPIRC_B64 }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      if: github.event_name == 'push' && env.GET_RELEASE == '404'
      run: |
        sudo snap install hub --classic
        ./.github/scripts/setup-secrets.sh
        make publish/release/python
        make publish/release/sonatype
        make publish/release/plugin
