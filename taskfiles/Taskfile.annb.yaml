version: '3'

tasks:
  submodule:
    desc: Setup the ann-benchmarks submodule
    status:
      - ls ann-benchmarks/.git
    cmds:
      - git submodule update --init ann-benchmarks

  install:
    desc: Install dependencies
    preconditions:
      - python3.6 --version
    dir: ann-benchmarks
    deps:
      - submodule
    env:
      PYTHONPATH: "{{ .PROJECT_ROOT }}/client-python"
    cmds:
      - python3.6 -m pip install --quiet virtualenv
      - python3.6 -m virtualenv -p python3.6 venv
      - venv/bin/pip install --quiet -r requirements.txt
      # We need client-python/requirements.txt, but the version of scipy requires Python >= 3.7.
      - venv/bin/pip install --quiet $(grep -v scipy {{ .PROJECT_ROOT }}/client-python/requirements.txt | xargs)
      - venv/bin/python -c "import importlib; importlib.import_module('ann_benchmarks.algorithms.elastiknn')"
      - venv/bin/python install.py --algorithm elastiknn

  clean:
    desc: Delete artifacts
    cmds:
      - rm -rf venv

  test:
    desc: Run ann-benchmarks using the Elastiknn algo on random data.
    dir: ann-benchmarks
    deps:
      - install
    env:
      PYTHONPATH: "{{ .PROJECT_ROOT }}/client-python"
    cmds:
      - sudo rm -rf results/random-xs-20-euclidean
      - venv/bin/python run.py --algorithm elastiknn-exact --dataset random-xs-20-euclidean --run-disabled --timeout 30 --local --force --runs 1
      - ls results/random-xs-20-euclidean/10/elastiknn-exact
      - venv/bin/python run.py --algorithm elastiknn-l2lsh --dataset random-xs-20-euclidean --run-disabled --timeout 30 --local --force --runs 1
      - ls results/random-xs-20-euclidean/10/elastiknn-l2lsh
      - sudo chmod -R 777 results/random-xs-20-euclidean
      - venv/bin/python plot.py --dataset random-xs-20-euclidean --output plot.png

  benchmark-official-fashion-mnist:
    desc: Run ann-benchmarks using released Elastiknn on the SIFT dataset.
    dir: ann-benchmarks
    deps:
      - install
    cmds:
      - venv/bin/python run.py --dataset fashion-mnist-784-euclidean --algorithm elastiknn-l2lsh --runs 3 --count 100 --parallelism 1 --force
      - sudo chmod -R 777 results/fashion-mnist-784-euclidean/100
      - venv/bin/python plot.py --dataset fashion-mnist-784-euclidean --count 100 --output plot-official-fashion-mnist.png

  benchmark-local-fashion-mnist:
    desc: Run ann-benchmarks using the local Elastiknn branch.
    dir: ann-benchmarks
    deps:
      - install
    cmds:
      - venv/bin/python run.py --dataset sift-128-euclidean --algorithm elastiknn-l2lsh --runs 3 --count 100 --parallelism 1 --force --local
      - sudo chmod -R 777 results/fashion-mnist-784-euclidean/100
      - venv/bin/python plot.py --dataset sift-128-euclidean --count 100 --output plot-local-fashion-mnist.png
