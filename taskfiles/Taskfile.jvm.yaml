version: '3'

tasks:

  clean:
    desc: Clean all JVM artifacts
    cmds:
      - find . -name target | xargs rm -rf

  compile:
    desc: Compile all JVM source code using Gradle
    sources:
      - build.sbt
      - project/**
      - "elastiknn-*/**"
    cmds:
      - sbt compile Test/compile

  test:
    desc: Run JVM tests using Gradle
    cmds:
      - sbt test

  plugin:publish:local:
    desc: Publish a local snapshot of the plugin
    sources:
      - "**/*.sbt"
      - "**/*.scala"
      - "elastiknn-*/**"
    cmds:
      - sbt elastiknn-plugin/elasticsearchPluginBundle

  plugin:publish:snapshot:
    desc: Publish a snapshot release to Github
    cmds:
      - sbt elasticsearchPluginBundle
      - hub release delete {{ .VERSION }} || true
      - hub release create -m {{ .VERSION }} -p -a elastiknn-plugin/target/elastiknn-*.zip {{ .VERSION }}

  plugin:publish:release:
    desc: Publish an official release to Github
    status:
      - curl -f -s -o /dev/null {{ .GITHUB_URL }}/releases/tag/{{ .VERSION }}
    cmds:
      - sbt elastiknn-plugin/elasticsearchPluginBundle
      - hub release create -m {{ .VERSION }} -p -a elastiknn-plugin/target/elastiknn-*.zip {{ .VERSION }}

  run:
    desc: Run Elasticsearch using SBT
    cmds:
      - sbt elastiknn-plugin/elasticsearchPluginRun

  debug:
    desc: Run Elasticsearch in debug mode using gradle
    cmds:
      - sbt elastiknn-plugin/elasticsearchPluginDebug
