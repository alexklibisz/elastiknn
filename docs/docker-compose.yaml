services:

  # Local development server with automatic recompilation.
  dev:
    container_name: elastiknn-docs-dev
    image: jekyll/jekyll:4.0
    volumes:
      - ".:/srv/jekyll"
      - "./.gemcache:/usr/gem/cache"
    command:
      - "/bin/bash"
      - "-ec"
      - |
        bundle install
        bundle exec jekyll serve --host 0.0.0.0
    ports:
      - "4000:4000/tcp"

  # Build site for publication. Output is in site/_site.
  compile:
    container_name: elastiknn-docs-build
    image: jekyll/jekyll:4.0
    volumes:
      - ".:/tmp/jekyll"
      - "./.gemcache:/usr/gem/cache"
    command:
      - "/bin/bash"
      - "-ec"
      - |
        cp -r /tmp/jekyll /srv/jekyll
        bundle install
        bundle exec jekyll build
        cp -r /srv/jekyll /tmp/jekyll
    environment:
      - JEKYLL_ENV=production
